## Cloudfront

Cloudfront is used for 2 things:
- Serving static JS/CSS bundles faster
- Serving photos from S3 with signed cookies for access control

Since signed cookies are used a custom domain for cloudfront is required (can't issue cookies unless the server domain is same as cloudfront).

Server domain: `plants.joshmedeiros.dev` (A record pointing at VPS)
CDN alt domain: `static.plants.joshmedeiros.dev` (CNAME record pointing at cloudfront distribution)

After creating the CNAME go to Cloudfront, select distribution, and under "Alternate domain names" click "Add domain.
- Enter `static.plants.joshmedeiros.dev`
- Click next, click "Create certificate" (ACM)
- Click the "Create certificate in ACM" external link next to it, you'll see 1 pending certificate
- Click the pending certificate, copy the "CNAME name" and "CNAME value" fields
- Go to DNS registrar and create a CNAME with those values (this is a challenge to validate ownership)
- Wait a few minutes for the records to propagate, cloudfront will automatically validate the domain
- Once it validates click "Next" then "Add domains" to confirm

### Origins

Create custom origin for static files (served from django with whitenoise, cached by cloudfront and served to user).
- Origin domain: `plants.joshmedeiros.dev`
- Protocol: HTTPS only

# TODO update this next time
Create S3 origin for photos
- Origin: Photos bucket
- Origin access: OAC
- Create OAC, copy JSON to S3 bucket policy

### Key Group (signed cookies)

Generate keypair:
```
openssl genrsa -out private_key.pem 2048
openssl rsa -pubout -in private_key.pem -out public_key.pem
```

Note: You'll need to upload `private_key.pem` to the docker host and mount it as a volume in docker compose.

Go to Cloudfront -> Key management -> Public keys - Create Public key
- Name: Plant-tracker-beta-photos
- Description: Used for cookie access control
- Key: contents of `public_key.pem`

Copy the ID cloudfront creates for the key (something like K86ALCJM6RYZT), you'll need it for the `CLOUDFRONT_KEY_ID` env var in docker compose.

Go to Cloudfront -> Key management -> Key groups - Create key group
- Name: Plant-tracker-beta-photos
- Description: Used for cookie access control
- Public keys: select key created above

### Behaviors

Default behavior: deny access
- Restrict viewer access: Yes
    - Trusted authorization type: Trusted signer
        - Trusted signers: self (just never sign anything)
- Cache policy: caching disabled

Static file behavior (public):
- Path pattern: `/static/*`
- Compress objects automatically: `Yes`
- Viewer protocol policy: `Redirect HTTP to HTTPS`
- Allowed HTTP methods: `GET, HEAD`
- Restrict viewer access: `No`
- Cache policy: `CachingOptimized`

Thumbnails behavior (signed cookies, long cache):
- Path pattern: `user_*/thumbnails/*`
- Origin: S3 bucket
- Compress objects automatically: `Yes`
- Viewer protocol policy: `Redirect HTTP to HTTPS`
- Allowed HTTP methods: `GET, HEAD`
- Restrict viewer access: `Yes`
    - Trusted authorization type: `Trusted key groups (recommended)`
        - Key group: Select key group created above
- Cache policy: `CachingOptimized`

Previews behavior (signed cookies, no cache):
- Path pattern: `user_*/previews/*`
- Origin: S3 bucket
- Compress objects automatically: `Yes`
- Viewer protocol policy: `Redirect HTTP to HTTPS`
- Allowed HTTP methods: `GET, HEAD`
- Restrict viewer access: `Yes`
    - Trusted authorization type: `Trusted key groups (recommended)`
        - Key group: Select key group created above
- Cache policy: `CachingDisabled`

# TODO custom policy with shorter TTL? These are large and infrequently accessed,
# don't want user device to push frequently-accessed thumbnails out of cache
Original resolution behavior (signed cookies, long cache):
- Path pattern: `user_*/images/*`
- Origin: S3 bucket
- Compress objects automatically: `Yes`
- Viewer protocol policy: `Redirect HTTP to HTTPS`
- Allowed HTTP methods: `GET, HEAD`
- Restrict viewer access: `Yes`
    - Trusted authorization type: `Trusted key groups (recommended)`
        - Key group: Select key group created above
- Cache policy: `CachingOptimized`

### Docker compose config

The following env vars are related to cloudfront:
- `CLOUDFRONT_KEY_ID` - The public key ID generated by cloudfront (Cloudfront -> Key management -> Public keys)
    - Example value: `K86ALCJM6RYZT`
- `CLOUDFRONT_IMAGE_DOMAIN` - The full cloudfront distribution alternate domain name with NO PROTOCOL (ie no https)
    - Example value: `static.plants.joshmedeiros.dev`
- `CLOUDFRONT_COOKIE_DOMAIN` - The base domain (remove subdomain) used to set cloudfront cookies
    - Example value: `.plants.joshmedeiros.dev`
- `DJANGO_STATIC_HOST` - The full cloudfront distribution alternate domain name WITH protocol
    - Example value: `https://static.plants.joshmedeiros.dev`


You'll also need to copy the `private_key.pem` used to sign the cookies to your docker host (same directory as docker-compose.yaml) and mount it as a volume:
```
    volumes:
      # Cloudfront private key for signed URLs (if using AWS S3)
      - ./private_key.pem:/mnt/backend/private_key.pem
```

If for some reason you want to mount this to a different location than `/mnt/backend/private_key.pem` set the `CLOUDFRONT_PRIVKEY_PATH` env var.
